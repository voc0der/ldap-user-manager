(function(){const e=window.LEASE_IP?.clientIp||null,t=!!window.LEASE_IP?.isAdmin,n="/lease_ip/api.php",o=async(e,t,o)=>{const s=n+"?"+encodeURIComponent(e)+"="+encodeURIComponent(null!=t?t:""),a=await fetch(s,{credentials:"include",headers:Object.assign({"Cache-Control":"no-store"},o||{})});let i;try{i=await a.json()}catch{return{ok:!1,error:"Invalid JSON from API"}}if(!a.ok||!1===i.ok)throw new Error(i.error||"HTTP "+a.status);return i},s=()=>Date.now(),a=e=>{if(void 0!==e.ts&&null!==e.ts){const t=Number(e.ts);if(Number.isFinite(t))return t>2e12?t:t>2e9?t:1e3*t;{const t=Date.parse(e.ts);if(!Number.isNaN(t))return t}}if(e.timestamp){const t=Date.parse(e.timestamp);if(!Number.isNaN(t))return t}return NaN},i=e=>{if(!Number.isFinite(e))return"—";if(e<=0)return"expired";const t=Math.floor(e/6e4),n=Math.floor(t/1440),o=Math.floor((t-1440*n)/60),s=t-1440*n-60*o;let a="";return n&&(a+=n+"d "),o||n&&(a+=o+"h "),a+=s+"m",a.trim()},r=(()=>{const e=6e5,t=220,n=180,o=new Map;let r=!1,l=null,d=null,c=!1,u=null,m=null,p=null,h="";const y=e=>String(null==e?"":e).replace(/[&<>"']/g,(e=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[e]))),g=()=>{if(r)return;r=!0;const e=`
#lum-geo-pop {
  position: fixed; z-index: 99999; min-width: 280px; max-width: 520px;
  background: radial-gradient(120% 140% at 0% 0%, rgba(42,139,220,0.25), rgba(18,24,32,0.96));
  backdrop-filter: blur(2px);
  border: 1px solid rgba(127,209,255,0.35);
  box-shadow: 0 0 24px rgba(42,139,220,0.35), inset 0 0 20px rgba(255,255,255,0.04);
  border-radius: 14px; padding: 10px 12px 12px 12px; color: #cfe9ff;
}
#lum-geo-pop .cg-head {
  display:flex; align-items:center; gap:8px; margin-bottom:6px;
  text-transform:uppercase; letter-spacing: .45px; font-size: 12px; color:#9fd1ff;
}
#lum-geo-pop .cg-ip { font-family: monospace; background:#102030; padding:2px 6px; border-radius: 8px; border:1px solid rgba(127,209,255,.35); color:#a9e1ff; }
#lum-geo-pop .cg-grid {
  display:grid; grid-template-columns: 128px 1fr; gap:6px 12px; font-size: 12.5px;
}
#lum-geo-pop .cg-key { color:#9fb6c9; text-transform:uppercase; letter-spacing:.3px; }
#lum-geo-pop .cg-val { color:#e5f4ff; overflow-wrap:anywhere; }
#lum-geo-pop .cg-bad { color:#ffb3b3; }
#lum-geo-pop .cg-warn { color:#ffdf9a; }
#lum-geo-pop .cg-flags { display:flex; flex-wrap:wrap; gap:6px; margin-top:6px; }
#lum-geo-pop .chip {
  font-size: 11px; border-radius: 999px; padding:2px 8px; border:1px solid rgba(255,255,255,.18);
  background: rgba(255,255,255,.04); color:#bfe9ff;
}
#lum-geo-pop .chip.negative { background: rgba(255,80,80,.12); border-color: rgba(255,80,80,.35); color:#ffdcdc; }
#lum-geo-pop .chip.warn { background: rgba(255,200,60,.10); border-color: rgba(255,200,60,.35); color:#fff0cc; }
#lum-geo-pop .cg-foot { margin-top:8px; display:flex; gap:8px; justify-content:flex-end; }
#lum-geo-pop .btn-mini {
  font-size: 11px; padding: 4px 8px; border-radius: 10px; background:#121820; color:#cfe9ff;
  border:1px solid rgba(255,255,255,.12); cursor:pointer;
}
#lum-geo-pop .btn-mini:hover { background:#17202b; }
.lum-ip-geo {
  cursor: help; border-bottom: 1px dotted rgba(127,209,255,.65); color:#a9e1ff; text-decoration:none;
}
.lum-ip-geo:hover { color:#e9f7ff; }
#lum-geo-arrow {
  position: fixed; width: 0; height: 0; border: 8px solid transparent; z-index: 99998;
  border-right-color: rgba(127,209,255,0.35);
}
@media (max-width: 480px) {
  #lum-geo-pop { max-width: 90vw; }
  #lum-geo-pop .cg-grid { grid-template-columns: 100px 1fr; }
}`;const t=document.createElement("style");t.id="lum-geo-style",t.textContent=e,document.head.appendChild(t)},f=()=>{l&&d||(l=document.createElement("div"),l.id="lum-geo-pop",l.style.display="none",d=document.createElement("div"),d.id="lum-geo-arrow",d.style.display="none",document.body.appendChild(l),document.body.appendChild(d),document.addEventListener("keydown",(e=>{"Escape"===e.key&&b(!0)})),document.addEventListener("click",(e=>{c&&l&&!l.contains(e.target)&&p&&!p.contains(e.target)&&b(!0)})),window.addEventListener("scroll",(()=>c?v(p):b(!1)),!0),window.addEventListener("resize",(()=>c?v(p):b(!1))))},E=(e,t)=>{const n=t?.geo||{};if(n.status&&"success"!==n.status)return void(l.innerHTML=`
          <div class="cg-head"><span class="cg-ip">${y(e)}</span><span class="cg-bad">lookup failed</span></div>
          <div class="cg-grid">
            <div class="cg-key">Message</div><div class="cg-val cg-bad">${y(n.message||"Unknown error")}</div>
          </div>
        `);const o=[n.city,n.regionName,n.countryCode?`${n.country} (${n.countryCode})`:n.country,n.zip].filter(Boolean).join(" · "),s=(n.asname||n.as||"").toString();l.innerHTML=`
        <div class="cg-head">
          <span class="cg-ip">${y(e)}</span>
          ${t.cached?'<span class="chip">cached</span>':""}
        </div>
        <div class="cg-grid">
          <div class="cg-key">Location</div><div class="cg-val">${y(o||"—")}</div>
          <div class="cg-key">ISP</div><div class="cg-val">${y(n.isp||"—")}</div>
          <div class="cg-key">Org</div><div class="cg-val">${y(n.org||"—")}</div>
          <div class="cg-key">ASN</div><div class="cg-val">${y(s||"—")}</div>
          <div class="cg-key">Timezone</div><div class="cg-val">${y(n.timezone||"—")}</div>
          <div class="cg-key">Reverse</div><div class="cg-val">${y(n.reverse||"—")}</div>
          <div class="cg-key">Coords</div><div class="cg-val">${null!=n.lat&&null!=n.lon?y(n.lat+", "+n.lon):"—"}</div>
        </div>
        <div class="cg-flags">
          ${n.proxy?'<span class="chip negative">proxy</span>':""}
          ${n.hosting?'<span class="chip warn">hosting/DC</span>':""}
          ${n.mobile?'<span class="chip warn">mobile</span>':""}
          ${n.continent?`<span class="chip">${y(n.continentCode||"")} ${y(n.continent)}</span>`:""}
          ${n.country?`<span class="chip">${y(n.country)}</span>`:""}
        </div>
        <div class="cg-foot">
          <button class="btn-mini" data-act="copy">Copy IP</button>
          <button class="btn-mini" data-act="unpin">Close</button>
        </div>
      `;const a=l.querySelector('[data-act="copy"]'),i=l.querySelector('[data-act="unpin"]');a?.addEventListener("click",(async t=>{try{await navigator.clipboard.writeText(e),a.textContent="Copied",setTimeout((()=>a.textContent="Copy IP"),1200)}catch{} })),i?.addEventListener("click",(()=>b(!0)))},v=e=>{if(!e||!l)return;const t=e.getBoundingClientRect(),n=window.innerWidth,o=window.innerHeight,s=10;let a=t.right+10,i=t.top;const r=Math.min(l.offsetWidth||420,520);a+r+16>n&&(a=Math.max(s,t.left-(r+18)),a<s&&(a=Math.max(s,n-r-s))),i+(l.offsetHeight||240)+16>o&&(i=Math.max(s,o-(l.offsetHeight||240)-s)),l.style.left=Math.round(a)+"px",l.style.top=Math.round(i)+"px";const c=8;d.style.top=Math.round(t.top+Math.min(t.height/2,Math.max(c+2,(l.offsetHeight||0)/3)))+"px",d.style.left=Math.round(Math.min(t.right+2,a-c))+"px"},w=(t,n,o)=>{clearTimeout(m),f(),p=t,h=n,g(),l.style.display="block",d.style.display="block",v(t),o.then((o=>{t===p&&n===h&&(E(n,o),v(t))})).catch((o=>{t===p&&n===h&&(l.innerHTML=`
          <div class="cg-head"><span class="cg-ip">${y(n)}</span><span class="cg-bad">lookup failed</span></div>
          <div class="cg-grid"><div class="cg-key">Error</div><div class="cg-val cg-bad">${y(o.message||"Request error")}</div></div>`) }))},b=e=>{clearTimeout(m),e&&(c=!1);if(c)return;l&&(l.style.display="none"),d&&(d.style.display="none"),p=null,h=""},x=async t=>{const n=o.get(t),r=s();if(n&&n.data&&r-n.t<e)return n.data;if(n&&n.pending)return n.pending;const l=fetch(`${"/lease_ip/api.php"}?geo=`+encodeURIComponent(t),{credentials:"include",headers:{"Cache-Control":"no-store"}}).then((async e=>{let n;try{n=await e.json()}catch{n={ok:!1,error:"Invalid JSON"}}if(!e.ok||!1===n.ok)throw new Error(n.error||"HTTP "+e.status);const s={cached:!!n.cached,geo:n.geo||{}};return o.set(t,{t:r,data:s}),s})).finally((()=>{const e=o.get(t);e&&e.pending&&o.delete(t)}));return o.set(t,{pending:l}),l};return{attach:(e,n)=>{e&&n&&(e.classList.add("lum-ip-geo"),e.addEventListener("mouseenter",(()=>{c||(clearTimeout(u),u=setTimeout((()=>w(e,n,x(n))),t))})),e.addEventListener("mouseleave",(()=>{c||(clearTimeout(u),m=setTimeout((()=>b(!1)),n))})),e.addEventListener("click",(t=>{if(t.preventDefault(),c&&p===e)return void b(!0);c=!0,w(e,n,x(n))})))} ,hide:b}})(),l=document.getElementById("user-status"),d=document.getElementById("btn-add"),c=document.getElementById("btn-del"),u=(e,t)=>e&&(e.disabled=!!t);let m=null,p=null;d?.addEventListener("click",(async()=>{u(d,!0);try{const t=await o("add",e||"");l.textContent="exists"===t.result?`Already present: ${t.ip}`:`Added: ${t.ip}`,"function"==typeof m&&m({force:!0}),"function"==typeof p&&p({force:!0})}catch(e){l.textContent="Add failed: "+e.message}finally{u(d,!1)}})),c?.addEventListener("click",(async()=>{u(c,!0);try{const t=await o("delete",e||"");l.textContent="not_found"===t.result?`Not present: ${t.ip}`:`Deleted: ${t.ip}`,"function"==typeof m&&m({force:!0}),"function"==typeof p&&p({force:!0})}catch(e){l.textContent="Delete failed: "+e.message}finally{u(c,!1)}})),function(){const e=document.getElementById("my-tbody");if(!e)return;const t=document.getElementById("my-count"),n=document.getElementById("my-refresh"),r=document.getElementById("my-status");let l="",d="",c=null;const u=t=>{e.innerHTML="";const n=96,o=s();for(const s of t){const t=document.createElement("tr"),a=document.createElement("td");a.textContent=s.user||s.label||s.host||"unknown";const i=document.createElement("td");i.textContent=s.source&&String(s.source).trim()?s.source:"—";const r=document.createElement("td");r.textContent=s.timestamp||"";const l=document.createElement("td");l.textContent=s.ip||"",!0===s.static&&(l.textContent+=" (static)");const d=document.createElement("td");let c="—",u="";if(!0===s.static)c="static";else{const e=a=>a;const a=e(s);if(Number.isFinite(a)){const e=a+3600000*n;c=i(e-o),u=new Date(e).toLocaleString()}function i(e){if(!Number.isFinite(e))return"—";if(e<=0)return"expired";const t=Math.floor(e/6e4),n=Math.floor(t/1440),o=Math.floor((t-1440*n)/60),s=t-1440*n-60*o;let a="";return n&&(a+=n+"d "),o||n&&(a+=o+"h "),a+=s+"m",a.trim()}}d.textContent=c,u&&(d.title=u);const m=document.createElement("td");m.className="text-right";const p=document.createElement("button");p.textContent="Delete",p.className="btn btn-default btn-sm",p.addEventListener("click",(async()=>{p.disabled=!0;try{await o("delete",s.ip),await f({force:!0}),r.textContent=`Deleted ${s.ip}`}catch(e){r.textContent="Delete failed: "+e.message}finally{p.disabled=!1}}));const h=document.createElement("button");h.textContent=!0===s.static?"Unset Static":"Set Static",h.className="btn btn-default btn-sm",h.style.marginLeft="0.5rem",h.addEventListener("click",(async()=>{h.disabled=!0;try{const e=!0!==s.static;await o("add",s.ip,{"X-LUM-Static":e?"1":"0"}),await f({force:!0}),r.textContent=e?`Marked static: ${s.ip}`:`Unmarked static: ${s.ip}`}catch(e){r.textContent="Static toggle failed: "+e.message}finally{h.disabled=!1}})),m.appendChild(p),m.appendChild(h),t.appendChild(a),t.appendChild(i),t.appendChild(r),t.appendChild(l),t.appendChild(d),t.appendChild(m),e.appendChild(t)}t.textContent=String(t.length)},m=e=>{try{return JSON.stringify(e)}catch{return String(e?.length||0)} };async function f({force:e=!1}={}){const t={"Cache-Control":"no-store"};!e&&l&&(t["If-None-Match"]=l);const n=await fetch("/lease_ip/api.php?list=1",{credentials:"include",headers:t});if(304===n.status)return void(r.textContent=`Up to date · ${new Date().toLocaleTimeString()}`);if(!n.ok)return void(r.textContent=`HTTP ${n.status}`);let o;try{o=await n.json()}catch{return void(r.textContent="Invalid JSON from API")}if(!1===o.ok)return void(r.textContent=o.error||"API error");const s=n.headers.get("ETag")||"";s&&(l=s);const a=o.entries||[],i=m(a);e||i===d?(r.textContent=`No changes · ${new Date().toLocaleTimeString()}`):(u(a),d=i,r.textContent=`Updated · ${new Date().toLocaleTimeString()}`)}function y(){c&&clearInterval(c),c=setInterval((()=>f({force:!1})),document.hidden?6e4:2e4)}document.addEventListener("visibilitychange",(()=>{document.hidden||f({force:!0})})),n?.addEventListener("click",(()=>f({force:!0}))),f({force:!0}),y()}(),function(){const e=document.getElementById("tbody");if(!e)return;const l=document.getElementById("count"),d=document.getElementById("btn-refresh"),c=document.getElementById("btn-clear"),u=document.getElementById("btn-prune"),m=document.getElementById("prune-hours"),h=document.getElementById("admin-status"),y=document.getElementById("manual-ip"),g=document.getElementById("manual-static"),f=document.getElementById("btn-add-manual");let E=[],v="",w="",b=null,x=null,S=null,I=0;const L=15000,C=6e4,k=1e4,A=e=>{h.textContent=e||""},N=t=>{e.innerHTML="";const n=parseFloat(m?.value||"96"),o=s();for(const s of t){const t=document.createElement("tr"),a=document.createElement("td");a.textContent=s.user||s.label||s.host||"unknown";const i=document.createElement("td");i.textContent=s.source&&String(s.source).trim()?s.source:"—";const r=document.createElement("td");r.textContent=s.timestamp||"";const l=document.createElement("td");if(s.ip)if(!0===s.static){const e=document.createElement("a");e.href="#",e.textContent=s.ip,e.style.marginRight="4px",l.appendChild(e);const n=document.createElement("span");n.textContent="(static)",n.style.opacity="0.8",n.style.marginLeft="2px",t&&r.attach&&r.attach(e,s.ip),l.appendChild(n)}else{const e=document.createElement("a");e.href="#",e.textContent=s.ip,l.appendChild(e),t&&r.attach&&r.attach(e,s.ip)}else l.textContent="";const d=document.createElement("td");let c="—",u="";if(!0===s.static)c="static";else{const e=a=>a;const t=e(s);if(Number.isFinite(t)){const e=t+3600000*n;c=i(e-o),u=new Date(e).toLocaleString()}function i(e){if(!Number.isFinite(e))return"—";if(e<=0)return"expired";const t=Math.floor(e/6e4),n=Math.floor(t/1440),o=Math.floor((t-1440*n)/60),s=t-1440*n-60*o;let a="";return n&&(a+=n+"d "),o||n&&(a+=o+"h "),a+=s+"m",a.trim()}}d.textContent=c,u&&(d.title=u);const p=document.createElement("td");p.className="text-right";const y=document.createElement("button");y.textContent="Delete",y.className="btn btn-default btn-sm",y.addEventListener("click",(async()=>{y.disabled=!0;try{await o("delete",s.ip),await D({force:!0}),A(`Deleted ${s.ip}`)}catch(e){A("Delete failed: "+e.message)}finally{y.disabled=!1}}));const g=document.createElement("button");g.textContent=!0===s.static?"Unset Static":"Set Static",g.className="btn btn-default btn-sm",g.style.marginLeft="0.5rem",g.addEventListener("click",(async()=>{g.disabled=!0;try{const e=!0!==s.static;await o("add",s.ip,{"X-LUM-Static":e?"1":"0"}),await D({force:!0}),A(e?`Marked static: ${s.ip}`:`Unmarked static: ${s.ip}`)}catch(e){A("Static toggle failed: "+e.message)}finally{g.disabled=!1}})),p.appendChild(y),p.appendChild(g),t.appendChild(a),t.appendChild(i),t.appendChild(r),t.appendChild(l),t.appendChild(d),t.appendChild(p),e.appendChild(t)}l.textContent=String(t.length)},T=e=>{try{return JSON.stringify(e)}catch{return String(e?.length||0)} },M=async(e={})=>{const{signal:t}=e,n="/lease_ip/api.php?list=1",o={"Cache-Control":"no-store"};w&&(o["If-None-Match"]=w);const s=await fetch(n,{credentials:"include",headers:o,signal:t});if(304===s.status)return{entries:null,etag:w,notModified:!0};if(!s.ok)throw new Error("HTTP "+s.status);let a;try{a=await s.json()}catch{throw new Error("Invalid JSON from API")}if(!1===a.ok)throw new Error(a.error||"API error");const i=s.headers.get("ETag")||"";return{entries:a.entries||[],etag:i,notModified:!1}},H=(e,{force:t=!1}={})=>{if(!e)return!1;const n=T(e);return!t&&n===v||(E=e,v=n,N(E),!0)};async function D({force:e=!1}={}){try{S?.abort()}catch{}if(S=new AbortController,e?A("Updating..."):A(""),!function(){return document.hidden?C:L}(),!0)try{const{entries:t,etag:n,notModified:o}=await M({signal:S.signal});n&&(w=n),o?A(`Up to date · ${new Date().toLocaleTimeString()}`):(H(t,{force:e}),A(`Updated ${H(t,{force:e})?"":"(no changes)"} · ${new Date().toLocaleTimeString()}`)),I=0}catch(e){I=Math.min(I?2*I:2e3,6e4),A(`Connection issue: ${e.message}. Retrying in ${Math.round(I/1e3)}s…`),function(e){b&& (clearTimeout(b),clearInterval(b),b=null);b=setTimeout((()=>{D({force:!1}).finally((()=>function(){b&&(clearTimeout(b),clearInterval(b),b=null)}()))}),e)}(I)}p=D;document.addEventListener("visibilitychange",(()=>{document.hidden?(function(){b&& (clearTimeout(b),clearInterval(b),b=null);b=setInterval((()=>D({force:!1})),document.hidden?C:L)}(),0):(D({force:!0}).finally((()=>function(){b&&(clearTimeout(b),clearInterval(b),b=null);b=setInterval((()=>D({force:!1})),document.hidden?C:L)}())))})),window.addEventListener("online",(()=>D({force:!0}))),window.addEventListener("offline",(()=>A("Offline"))),d?.setAttribute("title","Manual refresh (auto-refresh is on)"),d?.addEventListener("click",(()=>D({force:!0}))),c?.addEventListener("click",(async()=>{if(!confirm("Clear ALL entries?"))return;c.disabled=!0;try{await o("clear","1"),await D({force:!0}),A("Cleared all")}catch(e){A("Clear failed: "+e.message)}finally{c.disabled=!1}})),u?.addEventListener("click",(async()=>{const e=parseInt(m.value,10);if(!(e>0))return A("Enter a positive hour count.");u.disabled=!0;try{await o("prune",String(e)),await D({force:!0}),A(`Pruned entries older than ${e} hours`)}catch(e){A("Prune failed: "+e.message)}finally{u.disabled=!1}})),y?.addEventListener("keydown",(e=>{"Enter"===e.key&&(e.preventDefault(),f?.click())})),f?.addEventListener("click",(async()=>{const e=(y?.value||"").trim();if(!e)return A("Enter an IP address.");f.disabled=!0;try{const t=g?.checked?{"X-LUM-Static":"1"}:void 0,n=await o("add",e,t);await D({force:!0}),A("exists"===n.result?`Already present: ${n.ip}`:`Added: ${n.ip}`),y.value="",g&&(g.checked=!1)}catch(e){A("Add failed: "+e.message)}finally{f.disabled=!1}})),D({force:!0}),function(){b&& (clearTimeout(b),clearInterval(b),b=null);b=setInterval((()=>D({force:!1})),document.hidden?C:L)}(),function(){x&&clearInterval(x),x=setInterval((()=>{E&&E.length&&N(E)}),k)}() }()})();
